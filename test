import numpy as np
from scipy.stats import lognorm
from scipy.optimize import minimize
import matplotlib.pyplot as plt

SPECIES = ['H', 'He', 'C', 'N', 'O', 'Ne', 'Mg', 'Si', 'Ca', 'Fe']
ABUNDANCES = np.array([1.0, 0.98e-2, 3.63e-4, 1.2e-4, 8.51e-4, 1.23e-4, 3.80e-5, 3.55e-5, 2.29e-6, 4.68e-5])
Z = {'H':1,'He':2,'C':6,'N':7,'O':8,'Ne':10,'Mg':12,'Si':14,'Ca':20,'Fe':26}
A = {'H':1,'He':4,'C':12,'N':14,'O':16,'Ne':20,'Mg':24,'Si':28,'Ca':40,'Fe':56}
PROBS = ABUNDANCES / ABUNDANCES.sum()
KT_EV = 1e7

E_AUGER = np.array([17.8, 18.0, 18.2, 18.4, 18.6, 18.8, 19.0, 19.2, 19.4, 19.6])
XMAX_AUGER = np.array([739.2, 747.5, 756.8, 764.1, 769.3, 773.0, 774.8, 772.5, 767.2, 758.1])
XMAX_ERR = np.array([4.0, 3.5, 3.2, 3.0, 3.0, 3.5, 4.0, 5.0, 7.0, 10.0])
SIGMA_AUGER = np.array([55.0, 52.0, 48.0, 42.0, 38.0, 34.0, 30.0, 27.0, 25.0, 24.0])
SIGMA_ERR = np.array([3.0, 2.5, 2.2, 2.0, 2.0, 2.5, 3.0, 4.0, 5.0, 7.0])


def mean_xmax(log10e, mass):
    le = log10e - 19
    fe = 0.47 - 56.3 / np.log(10) + 1.15 * le
    return 806.1 + 56.3 * le + fe * np.log(mass)


def forward_model(log_eta_mu, log_eta_sigma, V_max, d_mpc, n=80000, seed=42):
    rng = np.random.default_rng(seed)
    idx = rng.choice(len(SPECIES), size=n, p=PROBS)
    sp_names = [SPECIES[i] for i in idx]
    z_arr = np.array([Z[s] for s in sp_names])
    a_arr = np.array([A[s] for s in sp_names])

    E_init = rng.standard_gamma(3, size=n) * KT_EV
    eta = lognorm(s=log_eta_sigma, scale=np.exp(log_eta_mu)).rvs(size=n, random_state=rng)
    E_acc = E_init + z_arr * eta * V_max

    z_cosmo = (67.4 / 3e5) * d_mpc
    lam_ad = 3e5 / (67.4 * (1 + z_cosmo))

    E_out = np.empty(n)
    sp_arr = np.array(sp_names)
    for s in set(sp_names):
        mask = sp_arr == s
        Ei = E_acc[mask]
        aa, zz = A[s], Z[s]
        E18 = Ei / 1e18
        r_bh = (aa / zz**2) * 1.02e3 * np.sqrt(np.maximum(E18, 1e-30)) / ((1+z_cosmo)**2.5 * 1.5)
        E20 = Ei / 1e20
        exp_arg = np.clip(0.83 * aa**0.79 / ((1+z_cosmo) * np.maximum(E20, 1e-30)), -50, 50)
        k_a = 1.0 if aa < 4 else (1.2 if aa == 4 else (3.6 if aa <= 22 else 4.349))
        r_dis = np.where(aa > 1, 3.0 * E20**2 * np.exp(exp_arg) / (k_a * aa**1.79 * (1+z_cosmo)), np.inf)
        inv_lam = 1.0/np.maximum(r_bh, 1e-30) + 1.0/np.maximum(r_dis, 1e-30) + 1.0/lam_ad
        E_out[mask] = Ei * np.exp(-d_mpc * inv_lam)

    return sp_arr, a_arr, E_out


def binned_observables(a_arr, E_final, E_bins, hw=0.15):
    log10e = np.log10(np.maximum(E_final, 1.0))
    xmax = mean_xmax(log10e, a_arr)
    m = np.full(len(E_bins), np.nan)
    s = np.full(len(E_bins), np.nan)
    for i, ec in enumerate(E_bins):
        sel = np.abs(log10e - ec) < hw
        if np.sum(sel) > 20:
            m[i] = np.mean(xmax[sel])
            s[i] = np.std(xmax[sel])
    return m, s


def chi2(params, V_max, d_mpc):
    mu, sig = params
    if sig <= 0.01 or sig > 3.0 or mu < -5 or mu > 1:
        return 1e10
    sp, a_arr, E_f = forward_model(mu, sig, V_max, d_mpc)
    alive = E_f > 1e17
    if np.sum(alive) < 500:
        return 1e10
    m, s = binned_observables(a_arr[alive], E_f[alive], E_AUGER)
    v = np.isfinite(m) & np.isfinite(s)
    if np.sum(v) < 3:
        return 1e10
    return float(np.sum(((m[v]-XMAX_AUGER[v])/XMAX_ERR[v])**2) + np.sum(((s[v]-SIGMA_AUGER[v])/SIGMA_ERR[v])**2))


def fit_eta(V_max, d_mpc):
    best = None
    for mu0 in [-2.0, -1.5, -1.0]:
        for sig0 in [0.3, 0.7]:
            res = minimize(chi2, [mu0, sig0], args=(V_max, d_mpc),
                           method='Nelder-Mead', options={'xatol':0.03, 'fatol':1.0, 'maxiter':200})
            if best is None or res.fun < best.fun:
                best = res
    return best


if __name__ == '__main__':
    cases = [(1e21, 10), (1e21, 20), (1e21, 50)]

    print(f"{'V_max':>12s} {'d[Mpc]':>8s} {'log_eta_mu':>12s} {'log_eta_sig':>12s} {'chi2':>10s}")
    print("-" * 58)

    fig, axes = plt.subplots(len(cases), 2, figsize=(12, 4*len(cases)), squeeze=False)
    e_ref = np.linspace(17, 21, 200)

    for row, (V, d) in enumerate(cases):
        res = fit_eta(V, d)
        mu, sig = res.x
        print(f"{V:12.2e} {d:8.0f} {mu:12.3f} {sig:12.3f} {res.fun:10.1f}")

        sp, a_arr, E_f = forward_model(mu, sig, V, d)
        alive = E_f > 1e17
        m, s = binned_observables(a_arr[alive], E_f[alive], E_AUGER)

        ax0 = axes[row, 0]
        ax0.errorbar(E_AUGER, XMAX_AUGER, XMAX_ERR, fmt='ks', ms=5, capsize=3, label='Auger')
        ax0.plot(E_AUGER[np.isfinite(m)], m[np.isfinite(m)], 'o-', color='steelblue', label='Model')
        ax0.plot(e_ref, mean_xmax(e_ref, 1), 'r--', lw=1, alpha=0.5, label='p')
        ax0.plot(e_ref, mean_xmax(e_ref, 56), 'b--', lw=1, alpha=0.5, label='Fe')
        ax0.set_ylabel(r'$\langle X_{\max}\rangle$ [g/cm$^2$]')
        ax0.set_ylim(650, 900)
        ax0.set_title(fr'$V_{{\max}}=10^{{{np.log10(V):.0f}}}$ V, $d={d}$ Mpc')
        ax0.legend(fontsize=8)
        ax0.grid(alpha=0.2)

        ax1 = axes[row, 1]
        ax1.errorbar(E_AUGER, SIGMA_AUGER, SIGMA_ERR, fmt='ks', ms=5, capsize=3, label='Auger')
        ax1.plot(E_AUGER[np.isfinite(s)], s[np.isfinite(s)], 'o-', color='darkorange', label='Model')
        ax1.set_ylabel(r'$\sigma(X_{\max})$ [g/cm$^2$]')
        ax1.set_ylim(0, 80)
        ax1.set_title(fr'$\mu_\eta={mu:.2f}$, $\sigma_\eta={sig:.2f}$, $\chi^2={res.fun:.1f}$')
        ax1.legend(fontsize=8)
        ax1.grid(alpha=0.2)

    for ax in axes[-1]:
        ax.set_xlabel(r'$\log_{10}(E/\mathrm{eV})$')
    plt.tight_layout()
    plt.savefig('fit_example.png', dpi=150, bbox_inches='tight')
    plt.close()
    print("\nSaved fit_example.png")
